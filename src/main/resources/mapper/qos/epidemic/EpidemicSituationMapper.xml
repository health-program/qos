<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paladin.qos.mapper.epidemic.EpidemicSituationMapper">

	<select id="searchFindPage" resultType="com.paladin.qos.service.epidemic.vo.EpidemicSituationVO">
		SELECT e.id,
		n.school_full_name AS incidentUnit,
		e.report_unit AS reportUnit,
		e.sickness_classify AS sicknessClassify,
		e.grade AS grade,
		e.region AS region,
		e.create_time AS createTime
		FROM
			epidemic_situation AS e
		LEFT JOIN org_school_name AS n ON e.incident_unit=n.id
		WHERE
			1 = 1
	
	<if test="incidentUnit !=null and incidentUnit != '' ">
		AND n.school_full_name  LIKE CONCAT('%',#{incidentUnit},'%')
	</if>
	
	<if test="reportUnit != null and reportUnit != '' ">
		AND e.report_unit =#{reportUnit}
	</if>
	
	<if test="region != null and region != '' ">
		AND e.region =#{region}
	</if>
	
	<if test="sicknessClassify != null and sicknessClassify != '' ">
		AND e.sickness_classify =#{sicknessClassify}
	</if>
	
	ORDER BY e.create_time DESC
	</select>
    
     <select id="dataTraceabilityRate" resultType="com.paladin.qos.service.epidemic.vo.DataEpidemicSituationVO">
	SELECT
		s.school_full_name as schoolName,
		TRUNCATE (
		(
		sum(
		is_early_warning_value = '1'
		AND is_reason_traceability = '1'
		) / count(1)
		) * 100,
		2
		) as rate
	FROM
		epidemic_situation AS e
	LEFT JOIN org_school_name AS s ON e.incident_unit = s.id
	where 1=1 
	
	<if test="region !=null and region !='' ">
		and e.region =#{region}
	</if>
	
	<if test="schoolYear !=null and schoolYear !='' ">
		and e.school_year =#{schoolYear}
	</if>
	
	GROUP BY incident_unit;
    </select> 
</mapper>
