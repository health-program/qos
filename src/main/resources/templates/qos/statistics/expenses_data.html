<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:include="/qos/header" />
<body>
    <tt:constant enumcode="data-event-type,data-unit-type" />
    <!--   <section class="content-header">
        <h1>数据展示</h1>
    </section> -->
    <section class="content">
        <div class="box box-solid">
            <div class="box-body">
                <form id="searchbar" class="form-horizontal form-search">
                    <div class="form-group">
                        <div class="col-md-2">
                            <select id="unitId" name="unitId" class="form-control tonto-select-constant" enumcode="data-unit-type">
                            <option value="">请选择医疗机构</option>
                            </select>
                        </div>
                         <div class="col-md-2">
                            <input id="createTime" name="date" placeholder="请输入时间" autocomplete="off" type="text" class="form-control" value="">
                        </div> 
                        <div class="col-md-8">
                            <div class="pull-right">
                                <button type="button" style="width:100px" class="btn btn-primary tonto-btn-search" onclick="table.refresh()"><i class="fa fa-search"></i>查询</button>
                                <button type="button" style="width:100px" class="btn btn-default" onclick="$('#searchbar').resetSearch()"><i class="fa fa-repeat"></i>重置</button>
                            </div>
                        </div>
                    </div>
                    <!-- 表单仅有一个text-input时回车会提交表单，这里添加一个无用的防止回车提交 -->
                    <input type="text" style="display:none">
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
				<div class="box box-solid">
					<div class="box-body">
						<table id="dataGrid"></table>
					</div>
				</div>
			</div>
            <div class="col-md-6">
                <div class="box box-solid">
                    <div id="drugsChartDiv" class="box-body" style="height: 400px">
                    </div>
                </div>
                <div class="box box-solid">
                    <div id="drugFeeChartDiv" class="box-body" style="height: 400px">
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div th:include="/qos/footer" />
    <script type="text/javascript" src="/static/js/chart.js"></script>
    <script type="text/javascript">
  //<![CDATA[
	//图表自适应大小      
	window.addEventListener("resize", function() {
		drugChart.resize();
		drugFeeChart.resize();
	});
	
    
    var table,arrValue;
    $(function() {
    	
    	 laydate.render({
             elem: '#createTime',
             type: 'month',
             max:'nowTime',
             value:''
         });
    	
        initTable();
    });


    function initTable() {
        table = $.createTable("#dataGrid", {
            idField: "id",
            columns: [
                [
                    { title: "医疗机构", field: "unitName" },
                    { title: "门急诊总人次", field: "oPDCount" },
                    { title: "门急诊总费用(元)", field: "oPDMoney" },
                    { title: "门急诊人均费用(元)", field: "oPDAverageMoney" },
                    { title: "住院人次", field: "inPatientCount" },
                    { title: "住院费用(元)", field: "inPatientMoney" },
                    { title: "住院人均费用(元)", field: "inPatietAverageMoney" },
                    { title: "转入人次", field: "inPersonCount" },
                    { title: "转出人次", field: "outPersonCount" }
                ]
            ],
            url: '/qos/expenses/find',
            pagination: false,
            searchbar: '#searchbar',
            queryParams: function(params) {
                requestParams = params;
                return params;
            },
            responseHandler: function(res) {
                sumData = res || [];
                var arr = [];
                
                for (var i = 0; i < sumData.length; i++) {
                  if (i == 0) arr.push(sumData[i]);
                  b = false;
                  if (arr.length > 0 && i > 0) {
                    for (var j = 0; j < arr.length; j++) {
                      if (arr[j].unitId == sumData[i].unitId) {
                    	  if(sumData[i].oPDCount != 0)arr[j].oPDCount = sumData[i].oPDCount;
                    	  if(sumData[i].oPDMoney != 0)arr[j].oPDMoney = sumData[i].oPDMoney;
                    	  
                    	  var oPDMoney = sumData[i].oPDMoney;
                    	  var oPDCount = arr[j].oPDCount;
                    	  if(oPDMoney != 0 && oPDCount !=0)
                    		  	arr[j].oPDAverageMoney = (oPDMoney/oPDCount).toFixed(2);
                    	  
                    	  if(sumData[i].inPatientCount != 0)arr[j].inPatientCount = sumData[i].inPatientCount;
                    	  if(sumData[i].inPatientMoney != 0)arr[j].inPatientMoney = sumData[i].inPatientMoney;
                    	  
                    	  var inPatientMoney = sumData[i].inPatientMoney;
                    	  var inPatientCount = arr[j].inPatientCount;
                    	  
                    	  if(inPatientMoney != 0 && inPatientCount != 0)
                    		  arr[j].inPatietAverageMoney = (inPatientMoney/inPatientCount).toFixed(2);
                    	  
                    	  if(sumData[i].inPersonCount != 0)arr[j].inPersonCount = sumData[i].inPersonCount;
                    	  if(sumData[i].outPersonCount != 0)arr[j].outPersonCount = sumData[i].outPersonCount;
                        b = true;
                      }
                    }
                    if (!b) {
                      arr.push(sumData[i]);
                    }
                  }
                }
                arrValue = arr;
                chart1(drugChart)
                chart2(drugFeeChart)
                return arr;
            }
        });
    }
    
    var drugChart = echarts.init(document.getElementById('drugsChartDiv'));
    var drugFeeChart = echarts.init(document.getElementById('drugFeeChartDiv'));
    
    function chart1(){
    	var xAxisData = dataAll();
    	drugChart.showLoading({
	           text: '数据正在努力加载...',
	           textStyle: { fontSize : 30 , color: '#444' },
	           effectOption: {backgroundColor: 'rgba(0, 0, 0, 0)'}
	       	}); 
    	var resultAll = [];
    	var date = [];
    	var opCount = [];
    	var inCount = [];
    	var unitId = $("#unitId").val();
    	var createTime = $("#createTime").val();
    	$.get('/qos/expenses/find/month',{"unitId":unitId,"date":createTime},function(res){
    		debugger;
    		var dataValue = res.result;
    		if(dataValue){
    				for(var i=0; i<dataValue.length;i++){
    					if (i == 0) resultAll.push(dataValue[i]);
    	                  b = false;
    	                  for (var j = 0; j < resultAll.length; j++) {
    	                	  if (dataValue[i].typeMonth == resultAll[j].typeMonth) {
    	                		  if(dataValue[i].oPDCount != 0)resultAll[j].oPDCount = dataValue[i].oPDCount;
    	                		  if(dataValue[i].inPatientCount != 0)resultAll[j].inPatientCount = dataValue[i].inPatientCount;
    	                		  b = true;
    	                	  }
    	                  }
    	                  if (!b) resultAll.push(dataValue[i]);
        			}
    		}
    		
    		for(var i=0; i<xAxisData.length;i++){
				for(var j=0;j<resultAll.length;j++){
					if(xAxisData[i] == resultAll[j].typeMonth){
						date.push(xAxisData[i]);
		    			opCount.push({name:xAxisData[i],value:resultAll[j].oPDCount});
		    			inCount.push({name:xAxisData[i],value:resultAll[j].inPatientCount})
		    			break;
					}
					if(j == resultAll.length-1){
						date.push(xAxisData[i]);
						opCount.push({name:xAxisData[i],value:0});
		    			inCount.push({name:xAxisData[i],value:0})
					}
				}
			}
    		drugChart.hideLoading();
        	option = {
        		    title: {
        		        text: '按日期分布'
        		    },
        		    tooltip : {
        		        trigger: 'axis',
        		        axisPointer: {
        		            type: 'cross',
        		            label: {
        		                backgroundColor: '#6a7985'
        		            }
        		        }
        		    },
        		    legend: {
        		        data:['门急诊人次','住院人次']
        		    },
        		    toolbox: {
        		        feature: {
        		            saveAsImage: {}
        		        }
        		    },
        		    grid: {
        		        left: '3%',
        		        right: '4%',
        		        bottom: '3%',
        		        containLabel: true
        		    },
        		    xAxis : [
        		        {
        		            type : 'category',
        		            boundaryGap : false,
        		            data :date,
        		            axisLabel: {
       		                 interval:0,
       		                 rotate:50//角度顺时针计算的
       		                } ,
        		        }
        		    ],
        		    yAxis : [
        		        {
        		            type : 'value'
        		        }
        		    ],
        		    series : [
        		        {
        		            name:'门急诊人次',
        		            type:'line',
        		            stack: '总量',
        		            smooth:0.3,
        		            areaStyle: {},
        		            itemStyle : {
              	                    normal : {
              							color: '#4a72c9',
              	                        lineStyle:{
              	                            width:0
              	                        }
              	                    }
    			            },
        		            data:opCount
        		        },
        		        {
        		            name:'住院人次',
        		            type:'line',
        		            stack: '总量',
        		            smooth:0.3,
        		            areaStyle: {},
        		            itemStyle : {
             	                    normal : {
             							color: '#2c97d2',
             	                        lineStyle:{
             	                            width:0
             	                        }
             	                    }
    		            },
        		            data:inCount
        		        }
        		    ]
        		};
        	drugChart.setOption(option,true);
    	})
    	

    }
    
    function chart2(){
    	if(arrValue){
    		 var oPDCountSeries =[],oPDCountxAxis =[];
    		 for (var i = 0; i < arrValue.length; i++) {
    			 oPDCountxAxis.push(arrValue[i].unitName);
    	         oPDCountSeries.push({name:arrValue[i].unitName,value:arrValue[i].oPDCount});
    		 }
    		
    		var option = {
        			title: {
    			        text: '门急诊总人次排名',
    			    },
        			color : [ '#3398DB' ],
        			tooltip : {
        				trigger : 'axis',
        				axisPointer : { // 坐标轴指示器，坐标轴触发有效
        					type : 'shadow' // 默认为直线，可选为：'line' | 'shadow'
        				}
        			},
        			 toolbox: {
         		        feature: {
         		            saveAsImage: {}
         		        }
         		    },
        			grid : {
        				left : '3%',
        				right : '4%',
        				bottom : '3%',
        				containLabel : true
        			},
        			xAxis : [ 
        			          {
        				type : 'category',
        				data : oPDCountxAxis,
        				 axisLabel: {
        		                 interval:0,
        		                 rotate:50//角度顺时针计算的
        		                } ,
        				axisTick : {
        					alignWithLabel : true
        				}
        			} 
        			],
        			yAxis : [ 
        			          {
        				type : 'value'
        			}
        			],
        			series : [ {
        				name : '门急诊总人次',
        				type : 'bar',
        					barWidth:20,
        				data : oPDCountSeries
        			} ]
        		};
        	drugFeeChart.setOption(option,true);
    	}
    }
    
    function dataAll(){
	       var dataArr = [];
	       var d = new Date()
	       d.setMonth(d.getMonth()-12);
	       console.log(d.toLocaleString())
	       for (var i = 0; i < 12; i++) {
	            d.setMonth(d.getMonth() + 1);//每次循环一次 月份值减1
	            var m = d.getMonth() + 1;
	            m = m < 10 ? "0" + m : m;
	            dataArr.push(d.getFullYear() + "-" + (m))
	        }
		return dataArr.sort();
	}
    
	//]]>
    </script>
</body>

</html>