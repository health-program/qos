<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:include="/qos/header" />

<body>
<tt:constant enumcode="data-event-type,data-unit-type" />
<!--   <section class="content-header">
    <h1>数据展示</h1>
</section> -->
<section class="content">
    <div class="box box-solid">
        <div class="box-body">
            <form id="searchbar" class="form-horizontal form-search">
                <div class="form-group">
                    <div class="col-md-2">
                        <select name="unitId" class="form-control">
                            <option value="">请选择单位</option>
                            <option th:each="unit : ${unit}" th:value="${unit.id}" th:text="${unit.name}"></option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input name="date" id="dateInput" placeholder="请选择月份" autocomplete="off" type="text" class="form-control">
                    </div>
                    <div class="col-md-8">
                        <div class="pull-right">
                            <button type="button" style="width:100px" class="btn btn-primary tonto-btn-search" onclick="table.refresh()"><i class="fa fa-search"></i>查询</button>
                            <button type="button" style="width:100px" class="btn btn-default" onclick="$('#searchbar').resetSearch()"><i class="fa fa-repeat"></i>重置</button>
                        </div>
                    </div>
                </div>
                <!-- 表单仅有一个text-input时回车会提交表单，这里添加一个无用的防止回车提交 -->
                <input type="text" style="display:none">
            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="box box-solid">
                <div class="box-body">
                    <table id="dataGrid"></table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="box box-solid">
                <div id="sumChartDiv" class="box-body" style="height: 300px">
                </div>
            </div>
            <div class="box box-solid">
                <div id="pieChartDiv" class="box-body" style="height: 400px">
                </div>
            </div>
        </div>
    </div>
</section>
<div th:include="/qos/footer" />
<script type="text/javascript" src="/static/js/chart.js"></script>
<script type="text/javascript">
    var table, sumChart, dayChart, sumData, requestParams;
    $(function() {
        var day=new Date();
        day.setTime(day.getTime());
        var month = day.getFullYear()+"-" + (day.getMonth()+1);
        laydate.render({
            elem: '#dateInput',
            type: 'month',
            value:month
        });
        initTable();
    });

    function getRate(row) {
        var e = row.userBedNumber,
            t = row.openBedNumber;
        if (t == 0) return 0;
        var x = e * 100 / t;
        if (x < 0.005) {
            return 0;
        }
        return x.toFixed(2) * 1;
    }

    function initTable() {
        table = $.createTable("#dataGrid", {
            idField: "id",
            columns: [
                [
                    { title: "医疗机构", field: "unitName" },
                    { title: "额定床位数", field: "bedNumber" },
                    { title: "实际开放总床日数", field: "openBedNumber" },
                    { title: "实际占用总床日数", field: "userBedNumber" },
                    {
                        title: "床位占用率",
                        field: "userBedRate",
                        formatter: function(value, row, index) {
                            return value + "%";
                        }
                    }
                ]
            ],
            url: '/qos/data/unit/bed/processing',
            pagination: false,
            searchbar: '#searchbar',
            clickToSelect: true,
            // onCheck: function(row) {
            //     console.log("on check");
            //     console.log(row);
            //
            // },
            // onUncheck: function(row) {
            //     console.log("on uncheck");
            //     console.log(row);
            // },
            queryParams: function(params) {
                requestParams = params;
                return params;
            },
            responseHandler: function(res) {
                sumData = res || [];
                for (var i = 0; i < sumData.length; i++) {
                    var row = sumData[i];
                    row.userBedRate = getRate(row);
                }
                initSumChart();
                initPieChart();

                return sumData;
            }
        });
    }


    function initSumChart() {


        if (!sumChart) {
            var dom = document.getElementById("sumChartDiv");
            var sumChart = echarts.init(dom);

            // Enable data zoom when user click bar.
            // var zoomSize = 6;
            // sumChart.on('click', function(params) {
            //     console.log(dataAxis[Math.max(params.dataIndex - zoomSize / 2, 0)]);
            //     sumChart.dispatchAction({
            //         type: 'dataZoom',
            //         startValue: dataAxis[Math.max(params.dataIndex - zoomSize / 2, 0)],
            //         endValue: dataAxis[Math.min(params.dataIndex + zoomSize / 2, data.length - 1)]
            //     });
            // });
        }
        if (sumData==0){
            showChartInfo(sumChart, '暂无数据显示');
            return false;
        }

        var dataAxis = [],
            data = [],
            yMax = 1, //100
            dataShadow = [];


        for (var i = 0; i < sumData.length; i++) {
            var it = sumData[i];
            dataAxis.push(it.unitName);
            data.push(it.userBedRate);
           //data.push(formatRate(it.userBedRate));

            // if (yMax < it.userBedRate) {
            //     yMax = it.userBedRate;
            // }
        }

        //yMax = Math.ceil(yMax / 10) * 10;

        // for (var i = 0; i < sumData.length; i++) {
        //     dataShadow.push(yMax);
        // }

        var	option = {
            title: {
                text: '床位占用率条形图',
            },
            color: ['#3398DB'],
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                },

                formatter: "{a} <br/>{b} : {c}%"

            },

            grid: {
                left: '0%',
                right: '0%',
                bottom: '5%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                axisLabel: {
                    interval:0,
                    rotate:25//角度顺时针计算的
                } ,
                axisTick : {
                    alignWithLabel : true
                },
                data: dataAxis
            },
            yAxis: {
                type: 'value',
                axisLabel: {
                    show:true,
                    formatter: '{value}%',//给Y轴数值添加百分号
                }
            },

            grid: {
                bottom: '110px',
            },
            series: [
                {
                    name: '床位占用率',
                    type: 'bar',
                    barWidth : 50,
                    itemStyle:{
                        normal:{
                            barBorderRadius:3,
                        }
                    },
                    data: data
                }
            ],
            legend: {
                data: '床位占用率',
                bottom:0
            }
        };
        sumChart.setOption(option,true);
    };



    function initPieChart() {
        var dom = document.getElementById("pieChartDiv");
        var pieChart = echarts.init(dom);
        if (sumData==0){
            showChartInfo(pieChart, '暂无数据显示');
            return false;
        }
        var sumOpen=0;
        var sumUse=0;
        var occupyRate=0;
        for (var i = 0; i < sumData.length; i++) {
            var it = sumData[i];
           sumOpen+=it.openBedNumber;
           sumUse+=it.userBedNumber;
        }
        var x = sumUse * 100 / sumOpen;
        occupyRate=x.toFixed(2) * 1;

        var option = {
            title: {
                text: '床位占用率',
            },
            color: ['#3398DB'],
            tooltip: {
                trigger: 'item',
                formatter: "{a} <br/>{b}: {c} ({d}%)"
            },

            series: [
                {
                    name:'实际床位占用率',
                    type:'pie',
                    radius: ['50%', '70%'],
                    avoidLabelOverlap: false,
                    label: {
                        normal: {
                            show: true,
                            position: 'center'
                        },
                        emphasis: {
                            show: false,
                            textStyle: {
                                fontSize: '30',
                                fontWeight: 'bold'
                            }
                        }
                    },

                    data:[
                        {value:occupyRate, name:'床位占用率'}
                    ]
                }
            ]
        };

        pieChart.setOption(option,true);
    }

    var showChartInfo = function (sumChart, infoStr) {
        var msgOption = {
            title: {
                show: true,
                textStyle: {
                    color: 'grey',
                    fontSize: 20
                },
                text: infoStr,
                left: 'center',
                top: 'center'
            },
            xAxis: {
                show: false
            },
            yAxis: {
                show: false
            },
            series: []
        };
        sumChart.clear();
        sumChart.hideLoading();
        sumChart.setOption(msgOption)
    };
</script>
</body>

</html>