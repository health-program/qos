<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:include="/qos/header" />

<body>
    <tt:constant enumcode="data-event-type,data-unit-type" />
    <!--   <section class="content-header">
        <h1>数据展示</h1>
    </section> -->
    <section class="content">
        <div class="box box-solid" style="height: 45px;margin-bottom: 10px">
            <div class="box-body no-pad-top">
                <form id="searchbar" class="form-horizontal form-search" style="margin-top: 5px;margin-left: 0;margin-right: 0">
                    <div class="form-group">
                        <div class="col-md-2">
                            <div class="input-group"><input name="startTime" id="startTime" placeholder="请输入开始时间" autocomplete="off" type="text" class="form-control tonto-datepicker-date" lay-key="1"></div>
                        </div>
                        <div class="col-md-2">
                            <div class="input-group"><input name="endTime" id="endTime" placeholder="请输入结束时间" autocomplete="off" type="text" class="form-control tonto-datepicker-date" lay-key="2"></div>
                        </div>
                        <div class="col-md-8">
                            <div class="pull-right">
                                <button type="button" style="width:100px" class="btn btn-primary tonto-btn-search" onclick="table.refresh()"><i class="fa fa-search"></i>查询</button>
                                <button type="button" style="width:100px" class="btn btn-default" onclick="$('#searchbar').resetSearch()"><i class="fa fa-repeat"></i>重置</button>
                            </div>
                        </div>
                    </div>
                    <!-- 表单仅有一个text-input时回车会提交表单，这里添加一个无用的防止回车提交 -->
                    <input type="text" style="display:none">
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="box box-solid">
                    <div class="box-body">
                        <table id="dataGrid"></table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="box box-solid">
                    <label for="monthInput" class="col-sm-3 control-label">重点手术住院死亡率趋势图</label>
                    <div id="sumChartDiv" class="box-body" style="height: 300px">
                    </div>
                </div>
                <div class="box box-solid">
                    <form class="form-horizontal" style="padding-top: 20px;padding-left: 20px">
                        <div class="form-group">
                            <label for="monthInput" class="col-sm-3 control-label">重点手术住院死亡率柱状图</label>
                        </div>
                    </form>
                    <div id="dayChartDiv" class="box-body" style="height: 300px">
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div th:include="/qos/footer" />
    <script type="text/javascript" src="/static/js/chart.js"></script>
    <script type="text/javascript">
    var table, sumChart, dayChart, sumData, requestParams;
    $(function() {
        initTable();
    });

    function initTable() {
        table = $.createTable("#dataGrid", {
            idField: "id",
            columns: [
                [
                    { checkbox: true },
                    {
                        title: "医疗机构",
                        field: "unitName"
                    },
                    {
                        title: "冠状动脉旁路<br>移植术死亡率",
                        field: "ev12100"
                    },
                    {
                        title: "经皮冠状动脉<br>介入治疗死亡率",
                        field: "ev12101"
                    },
                    {
                        title: "髋膝关节置换<br>术死亡率",
                        field: "ev12102"
                    },
                    {
                        title: "颅脑手术死亡率",
                        field: "ev12103"
                    },
                    {
                        title: "剖宫产死亡率",
                        field: "ev12104"
                    }
                ]
            ],
            url: '/qos/analysis/data/get/unit',
            pagination: false,
            searchbar: '#searchbar',
            clickToSelect: true,
            onCheck: function(row) {
                console.log("on check");
            },
            onUncheck: function(row) {
                console.log("on uncheck");
            },
            queryParams: function(params) {
                params.eventIds = '12100,12101,12102,12103,12104';
                requestParams = params;
                return params;
            },
            responseHandler: function(response) {
                var data = {};

                convertRate2TableData(response, '12100', data);
                convertRate2TableData(response, '12101', data);
                convertRate2TableData(response, '12102', data);
                convertRate2TableData(response, '12103', data);
                convertRate2TableData(response, '12104', data);

                var result = []
                for (var o in data) {
                    result.push(data[o]);
                }

                return result;
            }
        });
    }

    function convertRate2TableData(originData, eventId, data) {
        var eventData = originData[eventId],
            fieldName = 'ev' + eventId,
            total = 0,
            event = 0;

        eventData && eventData.forEach(function(item) {
            var id = item.unitId;
            unitData = data[id];
            if (!unitData) {
                unitData = {
                    unitId: id,
                    unitName: item.unitName
                };
                data[id] = unitData;
            }
            unitData[fieldName] = getRate(item);
            total += item.totalNum;
            event += item.eventNum;
        });

        var totalData = data['total'];
        if (!totalData) {
            totalData = {
                unitId: 'total',
                unitName: '合计',
            }
            data['total'] = totalData;
        }
        totalData[fieldName] = getRate({
            totalNum: total,
            eventNum: event
        });
    }

    function convertCount2TableData(originData, eventId, data) {
        var eventData = originData[eventId],
            fieldName = 'ev' + eventId,
            total = 0;

        eventData && eventData.forEach(function(item) {
            var id = item.unitId;
            unitData = data[id];
            if (!unitData) {
                unitData = {
                    unitId: id,
                    unitName: item.unitName
                };
                data[id] = unitData;
            }
            unitData[fieldName] = item.totalNum;
            total += item.totalNum;
        });

        var totalData = data['total'];
        if (!totalData) {
            totalData = {
                unitId: 'total',
                unitName: '合计',
            }
            data['total'] = totalData;
        }
        totalData[fieldName] = total;
    }

    function getRate(item, fixed) {
        var a = item.eventNum,
            b = item.totalNum,
            c = 0;
        if (a > 0 && b > 0)
            console.log(111);
        if (a && b) {
            c = a / b;
        }
        return c.toFixed(fixed) + '%';
    }

    var currentElement;

    function initDayChart() {
        var dataAxis = [], //x轴

            bypassGraftingRate = [],
            interventionRate = [],
            replacementRate = [],
            brainSurgeryRate = [],
            cesareanRate = [];
        var myChart = echarts.init(document.getElementById('dayChartDiv'));
        //x轴
        for (var i = 0; i < sumData.length - 1; i++) {
            var it = sumData[i];
            dataAxis.push(it.unitName);
        }
        for (var i = 0; i < sumData.length - 1; i++) {
            var it = sumData[i];
            bypassGraftingRate.push(it.bypassGraftingRate);
            interventionRate.push(it.interventionRate);
            replacementRate.push(it.replacementRate);
            brainSurgeryRate.push(it.brainSurgeryRate);
            cesareanRate.push(it.cesareanRate);
        }

        myChart.setOption({ //加载数据图表
            //color:['#1e90ff','#f0ffff'],
            title: {
                text: ''
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },

            grid: {
                left: '0%',
                right: '0%',
                bottom: '5%',
                containLabel: true
            },
            legend: {
                type: "scroll",
                data: ['冠状动脉旁路移植术死亡率', '经皮冠状动脉介入治疗死亡率', '髋膝关节置换术死亡率', '颅脑手术死亡率', '剖宫产死亡率'],
                bottom: 0
            },
            xAxis: {
                type: 'category',
                axisLabel: {
                    interval: 0,
                    rotate: 25 //角度顺时针计算的
                },
                axisTick: {
                    alignWithLabel: true
                },
                data: dataAxis,
            },
            yAxis: {
                type: 'value'
            },
            grid: {
                bottom: '50px',
            },
            series: [{
                    type: 'bar',
                    barWidth: 5,
                    itemStyle: {
                        normal: {
                            barBorderRadius: 2,
                        }
                    },
                    name: '冠状动脉旁路移植术死亡率',
                    data: bypassGraftingRate
                },
                {
                    type: 'bar',
                    barWidth: 5,
                    itemStyle: {
                        normal: {
                            barBorderRadius: 3,
                        }
                    },
                    name: '经皮冠状动脉介入治疗死亡率',
                    data: interventionRate
                },
                {
                    type: 'bar',
                    barWidth: 5,
                    itemStyle: {
                        normal: {
                            barBorderRadius: 3,
                        }
                    },
                    name: '髋膝关节置换术死亡率',
                    data: replacementRate
                },
                {
                    type: 'bar',
                    barWidth: 5,
                    itemStyle: {
                        normal: {
                            barBorderRadius: 3,
                        }
                    },
                    name: '颅脑手术死亡率',
                    data: brainSurgeryRate
                },
                {
                    type: 'bar',
                    barWidth: 5,
                    itemStyle: {
                        normal: {
                            barBorderRadius: 3,
                        }
                    },
                    name: '剖宫产死亡率',
                    data: cesareanRate
                }

            ]
        });

    }



    function initSumChart() {
        var yearMonth = [],
            bypassGraftingRate1 = [],
            interventionRate1 = [],
            replacementRate1 = [],
            brainSurgeryRate1 = [],
            cesareanRate1 = [];
        var myChart = echarts.init(document.getElementById('sumChartDiv'));
        var it = {};
        $.ajax({
            type: "post",
            async: true, //异步请求（同步请求将会锁住浏览器，用户其他操作必须等待请求完成才可以执行）
            url: "/qos/analysis/data/getMajorSurgeryByMonth",
            data: { "startTime": $("#startTime").val(), "endTime": $("#endTime").val() },
            dataType: "json", //返回数据形式为json
            success: function(data) {
                console.log(data.result);
                if (data.result) {
                    for (var i = 0; i < data.result.length; i++) {
                        var it = data.result[i];
                        yearMonth.push(it.year + "-" + it.month);
                    }
                    console.log(yearMonth);

                    for (var i = 0; i < data.result.length; i++) {
                        var row = data.result[i];
                        row.bypassGraftingRate = getBypassGraftingRate(row);
                        row.interventionRate = getInterventionRate(row);
                        row.replacementRate = getReplacementRate(row);
                        row.brainSurgeryRate = getBrainSurgeryRate(row);
                        row.cesareanRate = getCesareanRate(row);

                    }

                    for (var i = 0; i < data.result.length; i++) {
                        var it = data.result[i];
                        bypassGraftingRate1.push(it.bypassGraftingRate);
                        interventionRate1.push(it.interventionRate);
                        replacementRate1.push(it.replacementRate);
                        brainSurgeryRate1.push(it.brainSurgeryRate);
                        cesareanRate1.push(it.cesareanRate);

                    }



                    myChart.setOption({ //加载数据图表
                        //color:['#1e90ff','#f0ffff'],
                        title: {
                            text: ''
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            }
                        },
                        legend: {
                            type: "scroll",
                            data: ['冠状动脉旁路移植术死亡率', '经皮冠状动脉介入治疗死亡率', '髋膝关节置换术死亡率', '颅脑手术死亡率', '剖宫产死亡率'],
                            bottom: 0
                        },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,

                            data: yearMonth
                        },
                        grid: {
                            left: '0%',
                            right: '0%',
                            bottom: '5%',
                            containLabel: true
                        },
                        grid: {
                            bottom: '50px',
                        },
                        yAxis: { type: 'value' },
                        series: [{
                                type: 'line',
                                areaStyle: {},
                                label: {
                                    normal: {
                                        show: true, //显示数字
                                        position: 'top' //这里可以自己选择位置
                                    }
                                },
                                name: '冠状动脉旁路移植术死亡率',
                                data: bypassGraftingRate1
                            },
                            {
                                type: 'line',
                                areaStyle: {},
                                label: {
                                    normal: {
                                        show: true, //显示数字
                                        position: 'top' //这里可以自己选择位置
                                    }
                                },
                                name: '经皮冠状动脉介入治疗死亡率',
                                data: replacementRate1
                            },
                            {
                                type: 'line',
                                areaStyle: {},
                                label: {
                                    normal: {
                                        show: true, //显示数字
                                        position: 'top' //这里可以自己选择位置
                                    }
                                },
                                name: '髋膝关节置换术死亡率',
                                data: interventionRate1
                            },
                            {
                                type: 'line',
                                areaStyle: {},
                                label: {
                                    normal: {
                                        show: true, //显示数字
                                        position: 'top' //这里可以自己选择位置
                                    }
                                },
                                name: '颅脑手术死亡率',
                                data: brainSurgeryRate1
                            },
                            {
                                type: 'line',
                                areaStyle: {},
                                label: {
                                    normal: {
                                        show: true, //显示数字
                                        position: 'top' //这里可以自己选择位置
                                    }
                                },
                                name: '剖宫产死亡率',
                                data: cesareanRate1
                            }


                        ]
                    });
                }
            },
            error: function(errorMsg) {
                //请求失败时执行该函数
                myChart.hideLoading();
            }
        })
    };
    </script>
</body>

</html>