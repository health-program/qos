<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paladin.qos.mapper.shejike.SheJiKeMapper">
    <!-- 门诊人次数 -->
    <select id="getOutpatientNumber" resultType="Long">
        select count(*) from phis_webhis.V_OPR_REGISTER a
        where REGLEVLCODE ='5'
        and REGSTATUS = '0'
        and a.REGDATE &gt;= #{startTime}
        and a.REGDATE &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 急诊人次数 -->
    <select id="getEmergencyNumber" resultType="Long">
        select count(*) from phis_webhis.V_OPR_REGISTER a
        where REGLEVLCODE = '5'
        and REGSTATUS = '0'
        and a.REGDATE &gt;= #{startTime}
        and a.REGDATE &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 门急诊总人数 -->
    <select id="getPatientsNumber" resultType="Long">
        select count(*) from phis_webhis.V_OPR_REGISTER a
        where a.REGSTATUS = '0''
        and a.REGDATE &gt;= #{startTime}
        and a.REGDATE &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 出诊医生数 -->
    <select id="getVisitDoctorNumber" resultType="Long">
        select count(distinct(DOCTCODE)) from phis_webhis.V_OPM_RECIPE_INFO a
        where a.PRESSTATUS = '2' and a.CHARSTATUS = '2'
        and a.DRAWTIME &gt;= #{startTime}
        and a.DRAWTIME &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 医生平均门急诊量 -->
    <select id="getAverageNumber" resultType="Long">
        select round(count(*)/count(distinct(DOCTCODE)),2) as from phis_webhis.V_OPM_RECIPE_INFO a
        where a.PRESSTATUS = '2' and a.CHARSTATUS = '2'
        and a.DRAWTIME &gt;= #{startTime}
        and a.DRAWTIME &lt;#{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 康复服务数 -->
    <!-- 住院人次数 -->
    <select id="getInhospitalNumber" resultType="Long">
        select count(1) from phis_webhis.V_IPR_INPATIENTINFO a
        where a.INDATE &gt;= #{startTime}
        and a.INDATE &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 出院人次数 -->
    <select id="getOuthospitalNumber" resultType="Long">
        select count(OUT_DATE) from phis_webhis.V_IPR_INPATIENTINFO a
        where a.OUT_DATE &gt;= #{startTime}
        and a.OUT_DATE &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 在院人数 -->
    <select id="getOnhospitalNumber" resultType="Long">
        select count(INSTATE) from phis_webhis.V_IPR_INPATIENTINFO a
        where a.INSTATE in ('R','I')
        and a.INDATE &gt;= #{startTime}
        and a.INDATE &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 额定床位 -->
    <select id="getRatedBedNumber" resultType="Long">
        select count(*) from phis_webhis.V_COM_BEDINFO a
      	where a.ORGCODE = #{unitId}
    </select>
    <!-- 使用床位 -->
    <select id="getBedInUseNumber" resultType="Long">
        select count(*) from phis_webhis.V_INR_RECEIVEINFO a
        where a.INTIME &gt;= #{startTime}
        and a.INTIME &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 病床总天数 -->
    <select id="getBedTotalDays" resultType="Long">
        select count(1)
        from phis_webhis.v_com_bedinfo b
        where b.isused = '0'
        and ORGCODE = #{unitId}
    </select>
    <!-- 病床使用天数 -->
    <select id="getBedInUseDays" resultType="Long">
        select
        sum(Trunc(To_Date(a.enddate,
        'yyyy-mm-dd') + 1) -
        Trunc(To_Date(a.begindate,
        'yyyy-mm-dd')))
        bed
        from (select orgcode,
        to_char(indate, 'yyyy-mm-dd') indate,
        to_char(out_date, 'yyyy-mm-dd') out_date,
        INHOSNO,
        case
        when to_char(indate, 'yyyy-mm-dd') &gt; to_char(#{endTime}, 'yyyy-mm-dd') then to_char(#{endTime}, 'yyyy-mm-dd')
        when to_char(indate, 'yyyy-mm-dd') &gt;= to_char(#{startTime}, 'yyyy-mm-dd') then to_char(indate, 'yyyy-mm-dd')
        else to_char(#{startTime}, 'yyyy-mm-dd')
        end as begindate,
        case
        when to_char(out_date, 'yyyy-mm-dd') &lt; 'to_char(#{startTime}, 'yyyy-mm-dd') then to_char(#{startTime}, 'yyyy-mm-dd')
        when to_char(out_date, 'yyyy-mm-dd') &lt;= to_char(#{endTime}, 'yyyy-mm-dd') then to_char(out_date, 'yyyy-mm-dd')
        else to_char(#{endTime}, 'yyyy-mm-dd')
        end as enddate
        from phis_webhis.v_ipr_inpatientinfo
        where 1=1
        and ORGCODE = #{unitId}
    </select>
    <!-- 合计总收入 -->
    <select id="getTotalMoney" resultType="double">
        select round(SUM(TOTCOST),2) as totalMoney from phis_webhis.V_OPB_FEEDETAIL a
        where ITEMSTATUS = '0'
        and a.createtime &gt;= #{startTime}
        and a.createtime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 医疗收入 -->
    <select id="getMedicalMoney" resultType="double">
        select round(SUM(TOTCOST),2) as medicalMoney from phis_webhis.V_OPB_FEEDETAIL a
        where ITEMSTATUS = '0' and ISDRUG = '0'
        and a.createtime &gt;= #{startTime}
        and a.createtime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 药品收入 -->
    <select id="getDrugMoney" resultType="double">
        select round(SUM(TOTCOST),2) as drugMoney from phis_webhis.V_OPB_FEEDETAIL a
        where ITEMSTATUS = '0' and ISDRUG = '1'
        and a.createtime &gt;= #{startTime}
        and a.createtime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 其他收入 -->
    <select id="getOtherMoney" resultType="double">
        select round(SUM(TOTCOST),2) as drugMoney from phis_webhis.V_OPB_FEEDETAIL a
        where ITEMSTATUS = '0' and ISDRUG not in ('0','1')
        and a.createtime &gt;= #{startTime}
        and a.createtime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 处方数量 -->
    <select id="getPrescriptionNumber" resultType="long">
        select count(*) as prescriptionNumber from phis_webhis.V_OPM_RECIPE_INFO a
        where PRESSTATUS = '2' and CHARSTATUS = '2'
        and a.opertime &gt;= #{startTime}
        and a.opertime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 处方总额 -->
    <select id="getPrescriptionMoney" resultType="double">
        select round(sum(TOTCOST),2) as prescriptionMoney from phis_webhis.V_OPM_RECIPE_INFO a
        where a.PRESSTATUS = '2' and a.CHARSTATUS = '2'
        and a.opertime &gt;= #{startTime}
        and a.opertime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 最大处方金额 -->
    <select id="getMaxPrescriptionMoney" resultType="double">
        select round(MAX(TOTCOST),2) as maxPrescriptionMoney from phis_webhis.V_OPM_RECIPE_INFO a
        where a.PRESSTATUS = '2' and a.CHARSTATUS = '2'
        and a.opertime &gt;= #{startTime}
        and a.opertime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 最小处方金额 -->
    <select id="getMinPrescriptionMoney" resultType="double">
        select round(MIN(TOTCOST),2) a minPrescriptionMoney from phis_webhis.V_OPM_RECIPE_INFO a
        where a.PRESSTATUS = '2' and a.CHARSTATUS = '2'
        and a.opertime &gt;= #{startTime}
        and a.opertime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 平均处方金额 -->
    <select id="getAvgPrescriptionMoney" resultType="double">
        select round(AVG(TOTCOST),2) as avgPrescriptionMoney from phis_webhis.V_OPM_RECIPE_INFO a
        where a.PRESSTATUS = '2' and a.CHARSTATUS = '2'
        and a.opertime &gt;= #{startTime}
        and a.opertime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 门诊中医处方占比 -->
    <select id="getTotalChineseMedicinePrescription" resultType="long">
        select count(a.recipeid) from phis_webhis.v_opm_recipe_info a
        where a.PRESSTATUS = '2' and a.CHARSTATUS = '2'
        and a.opertime &gt;= #{startTime}
        and a.opertime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <select id="getEventChineseMedicinePrescription" resultType="long">
        select count(t.recipeid) as zycf
        from phis_webhis.v_opm_recipe_info a
        where a.BUSITYPE in ('2' ,'8' )
        and a.PRESSTATUS = '2'
        and a.CHARSTATUS = '2'
        and a.opertime &gt;= #{startTime}
        and a.opertime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 门诊中药饮片占比 -->
    <select id="getEventChineseDrinkMedicine" resultType="long">
        select count(t.recipeid) as zycf
        from phis_webhis.v_opm_recipe_info a
        where a.BUSITYPE ='2'
        and a.PRESSTATUS = '2'
        and a.CHARSTATUS = '2'
        and a.opertime &gt;= #{startTime}
        and a.opertime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 门诊中药非药物治疗处方占比 -->
    <select id="getEventNonChineseMedicinePrescription" resultType="long">
        select count(t.recipeid) as zycf
        from phis_webhis.v_opm_recipe_info a
        where a.BUSITYPE ='8'
        and a.PRESSTATUS = '2'
        and a.CHARSTATUS = '2'
        and a.opertime &gt;= #{startTime}
        and a.opertime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <!-- 静脉输液率 -->
    <!-- 激素使用率 -->
    <select id="getTotalHormone" resultType="long">
        select count(a.recipeid) from phis_webhis.v_opm_recipe_info a
        where a.PRESSTATUS = '2' and a.CHARSTATUS = '2'
        and a.opertime &gt;= #{startTime}
        and a.opertime &lt; #{endTime}
        and a.ORGCODE = #{unitId}
    </select>
    <select id="getEventHormone" resultType="long">
        select count(RECIPEID) as jssyl
        from phis_webhis.V_OPM_RECIPE_INFO t1
        where RECIPEID in
        (select t.recipeid
        from phis_webhis.V_OPB_FEEDETAIL t
        where (t.ITEMID, t.orgcode) in
        (select DRUG.DRUGID, DRUG.ORGCODE
        from phis_webhis.pha_druginfo DRUG
        where drugcode like '113%'))
        and t1.PRESSTATUS = '2'
        and t1.CHARSTATUS = '2'
        and t1.opertime &gt;= #{startTime}
        and t1.opertime &lt; #{endTime}
        and t1.ORGCODE = #{unitId}
    </select>
    <!-- 抗菌药物使用率 -->
    <select id="getTotalAntiDrug" resultType="double">
        select
        round(sum(b.totcost),2)
        from phis_webhis.v_opb_feedetail b
        where b.ITEMSTATUS = 0
        and b.createtime &gt;= #{startTime}
        and b.createtime &lt; #{endTime}
        and b.ORGCODE = #{unitId}
    </select>
    <select id="getEventAntiDrug" resultType="double">
        select
        round(sum(case when c.isantibiotic = '1' then b.totcost else 0 end),2)
        from phis_webhis.v_opb_feedetail b, phis_webhis.v_pha_drug c
        where b.itemid = c.drugid(+)
        and b.ITEMSTATUS = 0
        and b.createtime &gt;= #{startTime}
        and b.createtime &lt; #{endTime}
        and b.ORGCODE = #{unitId}
    </select>
    <!-- 一联抗生素使用率 -->
    <select id="getTotalRecipe" resultType="long">
        select count(r.recipeid) recipeall
        from phis_webhis.opm_recipe_info r
        where r.PRESSTATUS = '2'
        and r.CHARSTATUS = '2'
        and r.Opertime &gt;= #{startTime}
        and r.Opertime &lt; #{endTime}
        and r.ORGCODE = #{unitId}
    </select>
    <select id="getEventOneAntiDrug" resultType="long">
        select
        count(case
        when kss.kss = '1' then
        kss.kss
        end) as ylkss
        from (select t.recipeid, count(recipeid) as kss
        from phis_webhis.v_opb_feedetail t
        where t.ITEMID in
        (select DRUG.DRUGID
        from phis_webhis.v_pha_drug DRUG
        where DRUG.ISANTIBIOTIC = 1)
        AND t.createtime between #{startTime} and #{endTime}
        and orgcode = #{unitId}
        group by recipeid) kss
        left join phis_webhis.v_OPM_RECIPE_INFO info
        on kss.recipeid = info.recipeid
        where 1=1
        AND info.Opertime between #{startTime} and #{endTime}
        and info.orgcode = #{unitId}
        and info.PRESSTATUS = '2'
        and info.CHARSTATUS = '2'
    </select>
    <!-- 二联抗生素使用率 -->
    <select id="getEventTwoAntiDrug" resultType="long">
        select
        count(case
        when kss.kss = '2' then
        kss.kss
        end) as ylkss
        from (select t.recipeid, count(recipeid) as kss
        from phis_webhis.v_opb_feedetail t
        where t.ITEMID in
        (select DRUG.DRUGID
        from phis_webhis.v_pha_drug DRUG
        where DRUG.ISANTIBIOTIC = 1)
        AND t.createtime between #{startTime} and #{endTime}
        and orgcode = #{unitId}
        group by recipeid) kss
        left join phis_webhis.v_OPM_RECIPE_INFO info
        on kss.recipeid = info.recipeid
        where 1=1
        AND info.Opertime between #{startTime} and #{endTime}
        and info.orgcode = #{unitId}
        and info.PRESSTATUS = '2'
        and info.CHARSTATUS = '2'
    </select>
    <!-- 三联抗生素使用率 -->
    <select id="getEventThreeAntiDrug" resultType="long">
        select
        count(case
        when kss.kss = '3' then
        kss.kss
        end) as ylkss
        from (select t.recipeid, count(recipeid) as kss
        from phis_webhis.v_opb_feedetail t
        where t.ITEMID in
        (select DRUG.DRUGID
        from phis_webhis.v_pha_drug DRUG
        where DRUG.ISANTIBIOTIC = 1)
        AND t.createtime between #{startTime} and #{endTime}
        and orgcode = #{unitId}
        group by recipeid) kss
        left join phis_webhis.v_OPM_RECIPE_INFO info
        on kss.recipeid = info.recipeid
        where 1=1
        AND info.Opertime between #{startTime} and #{endTime}
        and info.orgcode = #{unitId}
        and info.PRESSTATUS = '2'
        and info.CHARSTATUS = '2'
    </select>
</mapper>